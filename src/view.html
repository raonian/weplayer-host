<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>view</title>
    <style>
        
    </style>
</head>

<body>
    <div>
        <video id="my-video" controls></video>
    </div>
    <script>
        const ws = new WebSocket('wss://192.168.96.115:8080');
        // ws.onmessage = function(event) {
        //     if(msg.sdp) {
        //         pc = new RTCPeerConnection(ice);
        //         pc.setRemoteDescription(msg.offer);
        //     } else if(msg.candidate) {
        //         pc.addIceCandidate(msg.candidate);
        //     }
        // };

        const ice = {
            'iceServers': [
                {'url': 'stun:stun.l.google.com:19302'}
                // {'url': 'turn:user@turnserver.com', 'credential': 'pass'}
            ]
        };
        // const signalingChannel = new SignalingChannel();
        let pc = null;
        ws.onmessage = function(event) {
            const msg = event.data.match(/type=(.+),(.+)/) || [];
            if(event.data === 'ws-connected') {
                ws.send('type=answer,0');
            }else if(msg[1] === 'offer') {
                pc = new RTCPeerConnection(ice);
                pc.setRemoteDescription({type: 'offer', sdp: event.data.split(',')[1]});

                pc.onicecandidate = function(evt) {
                    console.log('onicecandidate', evt);
                    if(evt.candidate) {
                        ws.send(evt.candidate);
                    }
                }
                pc.onaddstream = function(evt) {
                    console.log('onaddstream', evt);
                    document.getElementById('my-video').src = window.URL.createObjectURL(evt.stream);
                }
            }
        };

    </script>
</body>
</html>
